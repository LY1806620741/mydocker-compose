FROM centos:7

#整理环境
RUN mkdir -p /www/letsencrypt \
    && ln -s /www/letsencrypt /etc/letsencrypt \
    && rm -f /etc/init.d \
    && mkdir /www/init.d \
    && ln -s /www/init.d /etc/init.d \
    && mkdir /www/wwwroot

#宝塔安装脚本以及wget文件
ADD ./need/wget/* ./
#其他引导
ADD ./need/certbot-auto.init /www/server/panel/certbot-auto
ADD ./need/bt.init /etc/init.d/bt
RUN chmod +x /etc/init.d/bt

#增加清华源
ADD ./need/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo
#安装依赖
RUN yum install -y ntp python-devel python-imaging zip unzip openssl openssl-devel gcc libxml2 libxml2-devel libxslt* zlib zlib-devel libjpeg-devel libpng-devel libwebp libwebp-devel freetype freetype-devel lsof pcre pcre-devel vixie-cron crontabs icu libicu-devel c-ares mysql-devel
RUN unzip setuptools-33.1.1.zip && rm -f setuptools-33.1.1.zip && cd setuptools-33.1.1 && python setup.py install && cd .. && rm -rf setuptools-33.1.1 && easy_install -i https://pypi.tuna.tsinghua.edu.cn/simple pip
RUN pip install -i https://pypi.tuna.tsinghua.edu.cn/simple psutil chardet web.py virtualenv cryptography==2.1 mysql-python
 
RUN echo y | bash install.sh && rm install.sh

RUN yum clean all

HEALTHCHECK --interval=5s --timeout=3s CMD curl -fs http://localhost:8888/ && curl -fs http://localhost/ || exit 1 
EXPOSE 8888 8888

RUN echo -e "#!/bin/bash\nbt default\nbt start\nwhile true;do sleep 1;done" > entrypoint.sh && chmod +x entrypoint.sh
ENTRYPOINT ["./entrypoint.sh"]

